<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ComfyParamVisualizer</title>
<style>
:root { --bg:#fff; --fg:#111; --muted:#666; --border:#cfcfcf; --accent:#7a7afe; }
:root[data-theme="dark"]{ --bg:#0d0f13; --fg:#e5e7eb; --muted:#9aa0a6; --border:#2a2f3a; --accent:#7aa2ff; }
body{margin:0;font-family:sans-serif;background:var(--bg);color:var(--fg);}
.container{max-width:980px;margin:12px auto;padding:0 12px;}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
h1{margin:0;font-size:1.05rem;font-weight:600;}
.meta{font-size:0.85rem;color:var(--muted);margin-bottom:8px;}
.toggle{border:1px solid var(--border);background:transparent;color:var(--fg);
       border-radius:8px;padding:4px 8px;cursor:pointer;}
#sliders{border:1px solid var(--border);border-radius:8px;padding:8px 10px 2px 10px;
         background:rgba(127,127,127,0.03);}
.slider-row{display:grid;grid-template-columns:auto 16.1em 1fr;
            align-items:center;gap:10px;margin:10px 0;}
.label-col{justify-self:end;text-align:right;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.slider-wrap{display:flex;flex-direction:column;align-items:center;gap:2px;}
.value-bubble{font-size:0.85rem;color:var(--muted);}
#filename{text-align:center;font-size:0.85rem;opacity:0.7;margin:8px 0 6px 0;word-break:break-all;}
#filename a{color:inherit;text-decoration:underline;}
#canvas-wrap{display:flex;justify-content:center;padding:0 16px 16px 16px;position:relative;}
canvas{border:1px solid var(--border);background:#000;display:block;}
/* Play overlay for video (centered) */
.play-overlay{
  position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
  width:40px; height:40px; border-radius:50%;
  background:rgba(0,0,0,0.5);
  border:1px solid rgba(255,255,255,0.35);
  display:none; align-items:center; justify-content:center; cursor:pointer;
}
.play-overlay .tri{
  width:0; height:0;
  border-left:12px solid #fff;
  border-top:7px solid transparent;
  border-bottom:7px solid transparent;
  margin-left:3px;
}
/* Slider base */
input[type=range]{width:240px;height:26px;background:transparent;}
/* WebKit */
input[type=range]::-webkit-slider-runnable-track{height:6px;background:rgba(127,127,127,0.35);border-radius:6px;}
input[type=range]::-webkit-slider-thumb{
  -webkit-appearance:none;appearance:none;width:24px;height:24px;border-radius:50%;
  background:var(--accent);border:1px solid rgba(0,0,0,0.25);margin-top:-9px;}
input[type=range]:hover::-webkit-slider-thumb{width:26px;height:26px;margin-top:-10px;}
/* Firefox */
input[type=range]::-moz-range-track{height:6px;background:rgba(127,127,127,0.35);border-radius:6px;}
input[type=range]::-moz-range-thumb{
  width:24px;height:24px;border-radius:50%;background:var(--accent);
  border:1px solid rgba(0,0,0,0.25);}
input[type=range]:hover::-moz-range-thumb{width:26px;height:26px;}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ComfyParamVisualizer</h1>
    <button id="themeToggle" class="toggle" type="button">Theme</button>
  </div>
  <div class="meta">
  </div>
  <div id="sliders"></div>
  <div id="filename"><a id="filenameLink" href="#" target="_blank"></a></div>
  <div id="canvas-wrap">
    <canvas id="canvas"></canvas>
    <div id="playOverlay" class="play-overlay" title="Play video"><div class="tri"></div></div>
  </div>
</div>
<script>
(function(){
  const saved=localStorage.getItem("viewer_theme");
  if(saved==="dark"||( !saved && window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches)){
    document.documentElement.setAttribute("data-theme","dark");
  }
  document.getElementById("themeToggle").onclick=function(){
    const cur=document.documentElement.getAttribute("data-theme");
    if(cur==="dark"){document.documentElement.removeAttribute("data-theme");localStorage.setItem("viewer_theme","light");}
    else{document.documentElement.setAttribute("data-theme","dark");localStorage.setItem("viewer_theme","dark");}
  };
})();
const data={"dim_values": [[{"k": "3", "d": "3"}, {"k": "4", "d": "4"}], [{"k": "3.0", "d": "3.0"}, {"k": "4.0", "d": "4.0"}]], "poster_lookup": {"3|3.0": "104-shift-3_0--103-shift-3_0_00002_.png", "3|4.0": "104-shift-3_0--103-shift-4_0_00002_.png", "4|3.0": "104-shift-4_0--103-shift-3_0_00002_.png", "4|4.0": "104-shift-4_0--103-shift-4_0_00002_.png"}, "video_lookup": {"3|3.0": "104-shift-3_0--103-shift-3_0_00001_.mp4", "3|4.0": "104-shift-3_0--103-shift-4_0_00001_.mp4", "4|3.0": "104-shift-4_0--103-shift-3_0_00001_.mp4", "4|4.0": "104-shift-4_0--103-shift-4_0_00001_.mp4"}, "dim_labels": ["ModelSamplingSD3:104:shift", "ModelSamplingSD3:103:shift"], "label_em": 16.12, "lazy": true, "poster_urls": {"104-shift-3_0--103-shift-3_0_00002_.png": "104-shift-3_0--103-shift-3_0_00002_.png", "104-shift-3_0--103-shift-4_0_00002_.png": "104-shift-3_0--103-shift-4_0_00002_.png", "104-shift-4_0--103-shift-3_0_00002_.png": "104-shift-4_0--103-shift-3_0_00002_.png", "104-shift-4_0--103-shift-4_0_00002_.png": "104-shift-4_0--103-shift-4_0_00002_.png"}, "video_urls": {"104-shift-3_0--103-shift-3_0_00001_.mp4": "104-shift-3_0--103-shift-3_0_00001_.mp4", "104-shift-3_0--103-shift-4_0_00001_.mp4": "104-shift-3_0--103-shift-4_0_00001_.mp4", "104-shift-4_0--103-shift-3_0_00001_.mp4": "104-shift-4_0--103-shift-3_0_00001_.mp4", "104-shift-4_0--103-shift-4_0_00001_.mp4": "104-shift-4_0--103-shift-4_0_00001_.mp4"}};
const dims=data.dim_values.length;
const curIdx=new Array(dims).fill(0);
const locked=new Array(dims).fill(false);
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
const fnameLink=document.getElementById("filenameLink");
const slidersRoot=document.getElementById("sliders");
const wrap=document.getElementById("canvas-wrap");
const playOverlay=document.getElementById("playOverlay");
let videoEl=null;

// Image LRU cache for lazy mode
const CAP=64;
const map=new Map();
const imgs={
  has:(k)=>map.has(k),
  get:(k)=>map.get(k),
  set:(k,img)=>{
    if(map.has(k)) map.delete(k);
    map.set(k,img);
    if(map.size>CAP){
      const oldest=map.keys().next().value;
      const oldImg=map.get(oldest);
      oldImg.src="";
      map.delete(oldest);
    }
  }
};

// Track current natural image size
let natW=0, natH=0;

// Compute scaled canvas size to fit viewport with 16px L/R/B margins, no upscaling
function sizeCanvasFor(nw, nh){
  const MLR = 16; // left/right margin
  const MB = 16;  // bottom margin
  const availW = Math.max(1, window.innerWidth - (MLR*2));
  const anchor = document.getElementById("filename");
  const bottomOfHeader = anchor.getBoundingClientRect().bottom; // px from top
  const availH = Math.max(1, window.innerHeight - bottomOfHeader - MB);
  const scale = Math.min(1, availW / nw, availH / nh);
  const sw = Math.max(1, Math.floor(nw * scale));
  const sh = Math.max(1, Math.floor(nh * scale));
  if (canvas.width !== sw || canvas.height !== sh){
    canvas.width = sw;
    canvas.height = sh;
  }
  if (typeof videoEl !== 'undefined' && videoEl){
    videoEl.width = sw;
    videoEl.height = sh;
    videoEl.style.width = sw + 'px';
    videoEl.style.height = sh + 'px';
  }
}

// Redraw current image to fit
function redrawCurrent(){
  if (!currentImg) return;
  sizeCanvasFor(natW, natH);
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(currentImg, 0, 0, canvas.width, canvas.height);
}

// Initialize after first image is ready
function initAfterFirstImage(w,h){
  natW=w; natH=h;
  sizeCanvasFor(natW, natH);
  buildUI(); updateImage();
  window.addEventListener("resize",redrawCurrent);
}

// Load one arbitrary image to size the canvas
const firstFname = Object.values(data.poster_lookup)[0];
const probe=new Image();
probe.onload=()=>initAfterFirstImage(probe.naturalWidth, probe.naturalHeight);
probe.onerror=()=>initAfterFirstImage(512,512);
probe.src=data.poster_urls[firstFname];

function sliderWidth(n){return Math.min(680,Math.max(140,140+(n-2)*36));}
function buildUI(){
  for(let i=0;i<dims;i++){
    const row=document.createElement("div");row.className="slider-row";
    const lock=document.createElement("input");lock.type="checkbox";
    const label=document.createElement("div");label.className="label-col";label.textContent=data.dim_labels[i];
    const wrap=document.createElement("div");wrap.className="slider-wrap";
    const bubble=document.createElement("div");bubble.className="value-bubble";bubble.textContent=data.dim_values[i][0].d;
    const slider=document.createElement("input");slider.type="range";
    slider.min=0;slider.max=data.dim_values[i].length-1;slider.step=1;slider.value=0;
    slider.style.width=sliderWidth(data.dim_values[i].length)+"px";
    lock.onchange=()=>{locked[i]=lock.checked;slider.disabled=lock.checked;};
    slider.oninput=()=>{if(locked[i])return;curIdx[i]=+slider.value;bubble.textContent=data.dim_values[i][curIdx[i]].d;updateImage();};
    wrap.appendChild(bubble);wrap.appendChild(slider);
    row.appendChild(lock);row.appendChild(label);row.appendChild(wrap);
    slidersRoot.appendChild(row);
  }
}
function key(){return curIdx.map((v,d)=>data.dim_values[d][v].k).join("|");}

let currentUrl=null;
let currentImg=null;
let currentKey=null;
let hasVideoCurrent=false;
function updateImage(){
  const k=key();
  currentKey=k;
  stopVideo();
  const fname=data.poster_lookup[k];
  if(!fname){ fnameLink.textContent="No match"; fnameLink.removeAttribute("href"); currentUrl=null; hasVideoCurrent=false; playOverlay.style.display='none'; return; }
  const url=data.poster_urls[fname];
  hasVideoCurrent = !!data.video_lookup[k];
  let im = imgs.has(fname) ? imgs.get(fname) : null;
  if(im && im.complete){
    drawAndLink(im, url, fname);
    return;
  }
  im = new Image();
  im.onload=()=>{ imgs.set(fname, im); drawAndLink(im, url, fname); };
  im.onerror=()=>{ fnameLink.textContent="Failed to load: "+fname; currentUrl=null; };
  im.src=url;
}

function drawAndLink(im, url, fname){
  currentImg = im;
  natW = im.naturalWidth || im.width;
  natH = im.naturalHeight || im.height;
  sizeCanvasFor(natW, natH);
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(im, 0, 0, canvas.width, canvas.height);
  currentUrl=url;
  fnameLink.textContent=fname;
  fnameLink.href=url;
  fnameLink.download=fname;
  // show play overlay only on hover and when video exists
  playOverlay.style.display='none';
}

document.getElementById("canvas").addEventListener("contextmenu",e=>{
  e.preventDefault();
  if(currentUrl) window.open(currentUrl,"_blank","noopener,noreferrer");
});

// Hover/click to toggle video if available
wrap.addEventListener('mouseenter', ()=>{ if(hasVideoCurrent && !videoEl) playOverlay.style.display='flex'; });
wrap.addEventListener('mouseleave', ()=>{ playOverlay.style.display='none'; });
playOverlay.addEventListener('click', ()=>{ if(hasVideoCurrent) launchVideo(); });
canvas.addEventListener('click', ()=>{ if(hasVideoCurrent) launchVideo(); });

function launchVideo(){
  if(videoEl) return;
  const vf = data.video_lookup[currentKey];
  if(!vf) return;
  const vurl = data.video_urls[vf];
  videoEl = document.createElement('video');
  videoEl.controls = true;
  videoEl.autoplay = true;
  videoEl.playsInline = true;
  videoEl.poster = currentUrl || '';
  videoEl.src = vurl;
  videoEl.style.display='block';
  videoEl.style.background='#000';
  // match canvas size
  videoEl.width = canvas.width;
  videoEl.height = canvas.height;
  videoEl.style.width = canvas.width + 'px';
  videoEl.style.height = canvas.height + 'px';
  canvas.style.display='none';
  wrap.appendChild(videoEl);
  playOverlay.style.display='none';
  // update link to video while playing
  fnameLink.textContent = vf;
  fnameLink.href = vurl;
  fnameLink.download = vf;
  videoEl.addEventListener('ended', ()=>{ stopVideo(true); });
}

function stopVideo(updateLinkBack){
  if(!videoEl) return;
  try{ videoEl.pause(); }catch(e){}
  try{ videoEl.removeAttribute('src'); videoEl.load?.(); }catch(e){}
  try{ videoEl.remove(); }catch(e){}
  videoEl=null;
  canvas.style.display='block';
  if(updateLinkBack){
    const pf = data.poster_lookup[currentKey];
    if(pf){
      const purl = data.poster_urls[pf];
      fnameLink.textContent = pf;
      fnameLink.href = purl;
      fnameLink.download = pf;
    }
  }
}

</script>
</body>
</html>
